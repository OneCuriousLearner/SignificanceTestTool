#!/bin/bash

# CSV æ•°æ®æ˜¾è‘—æ€§åˆ†æå·¥å…· - å¯åŠ¨è„šæœ¬

echo "========================================"
echo "  CSV æ•°æ®æ˜¾è‘—æ€§åˆ†æå·¥å…·"
echo "========================================"
echo ""

# æ£€æŸ¥æ˜¯å¦å®‰è£…äº†å¿…è¦çš„ä¾èµ–
check_dependencies() {
    echo "ğŸ” æ£€æŸ¥ä¾èµ–..."
    
    # æ£€æŸ¥ Python
    if ! command -v python3 &> /dev/null; then
        echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° python3ï¼Œè¯·å…ˆå®‰è£… Python 3"
        exit 1
    fi
    
    # æ£€æŸ¥ uv
    if ! command -v uv &> /dev/null; then
        echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° uvï¼Œè¯·å…ˆå®‰è£… UV"
        exit 1
    fi
    
    echo "âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥å¹¶é‡Šæ”¾ç«¯å£
check_and_free_ports() {
    echo ""
    echo "ï¿½ æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ..."
    
    # æ£€æŸ¥ 3000 ç«¯å£ï¼ˆå‰ç«¯ï¼‰
    FRONTEND_PID=$(lsof -ti:3000 2>/dev/null)
    if [ ! -z "$FRONTEND_PID" ]; then
        echo "âš ï¸  ç«¯å£ 3000 å·²è¢«è¿›ç¨‹ $FRONTEND_PID å ç”¨ï¼Œæ­£åœ¨é‡Šæ”¾..."
        kill -9 $FRONTEND_PID 2>/dev/null
        sleep 1
        echo "âœ… ç«¯å£ 3000 å·²é‡Šæ”¾"
    fi
    
    # æ£€æŸ¥ 5000 ç«¯å£ï¼ˆåç«¯ï¼‰
    BACKEND_PID=$(lsof -ti:5000 2>/dev/null)
    if [ ! -z "$BACKEND_PID" ]; then
        echo "âš ï¸  ç«¯å£ 5000 å·²è¢«è¿›ç¨‹ $BACKEND_PID å ç”¨ï¼Œæ­£åœ¨é‡Šæ”¾..."
        kill -9 $BACKEND_PID 2>/dev/null
        sleep 1
        echo "âœ… ç«¯å£ 5000 å·²é‡Šæ”¾"
    fi
    
    echo "âœ… ç«¯å£æ£€æŸ¥å®Œæˆ"
}

# å¯åŠ¨å‰ç«¯æœåŠ¡
start_frontend() {
    echo ""
    echo "ğŸŒ å¯åŠ¨å‰ç«¯æœåŠ¡..."
    ./start_frontend.sh &
    FRONTEND_PID=$!
    echo "å‰ç«¯è¿›ç¨‹ PID: $FRONTEND_PID"
    sleep 2
}

# å¯åŠ¨åç«¯æœåŠ¡
start_backend() {
    echo ""
    echo "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡..."
    ./start_backend.sh &
    BACKEND_PID=$!
    echo "åç«¯è¿›ç¨‹ PID: $BACKEND_PID"
    sleep 2
}

# æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
show_info() {
    echo ""
    echo "========================================"
    echo "  ğŸ‰ æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
    echo "========================================"
    echo ""
    echo "ğŸ“Œ è®¿é—®åœ°å€:"
    echo "   å‰ç«¯: http://localhost:3000"
    echo "   åç«¯: http://localhost:5000"
    echo ""
    echo "ğŸ“‹ ä½¿ç”¨è¯´æ˜:"
    echo "   1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:3000"
    echo "   2. ä¸Šä¼  CSV æ–‡ä»¶"
    echo "   3. é€‰æ‹© Baseline åˆ—å’Œæ•°æ®åˆ—"
    echo "   4. ç‚¹å‡»è¿è¡Œåˆ†ææŸ¥çœ‹ç»“æœ"
    echo ""
    echo "âš ï¸  åœæ­¢æœåŠ¡: æŒ‰ Ctrl+C"
    echo "========================================"
    echo ""
    echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—:"
    echo "   åç«¯æ—¥å¿—å°†åœ¨ä¸‹æ–¹æ˜¾ç¤º"
    echo ""
}

# æ¸…ç†å‡½æ•°
cleanup() {
    echo ""
    echo "ğŸ›‘ æ­£åœ¨åœæ­¢æœåŠ¡..."
    
    if [ ! -z "$BACKEND_PID" ]; then
        kill $BACKEND_PID 2>/dev/null
        echo "âœ… åç«¯æœåŠ¡å·²åœæ­¢"
    fi
    
    if [ ! -z "$FRONTEND_PID" ]; then
        kill $FRONTEND_PID 2>/dev/null
        echo "âœ… å‰ç«¯æœåŠ¡å·²åœæ­¢"
    fi
    
    echo "ğŸ‘‹ å†è§ï¼"
    exit 0
}

# æ•è· Ctrl+C
trap cleanup SIGINT SIGTERM

# ä¸»æµç¨‹
main() {
    check_dependencies
    check_and_free_ports
    start_frontend
    start_backend
    show_info
    
    # ç­‰å¾…åç«¯è¿›ç¨‹ï¼ˆå‰ç«¯åœ¨åå°è¿è¡Œï¼‰
    wait $BACKEND_PID
}

# è¿è¡Œä¸»æµç¨‹
main
